version: 2.1
orbs:
  docker: circleci/docker@2.2.0
jobs:
  build-push-and-deploy:
    docker:
      - image: google/cloud-sdk:latest
    steps:
      - checkout
      - run:
          name: Start DinD container
          command: |
            docker run -d --privileged -p 2375:2375 docker:dind
      - run:
          name: Set Docker API endpoint
          command: export DOCKER_HOST=tcp://localhost:2375
      - run:
          name: Authenticating and configuring the Google Cloud Platform
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
      - run:
          name: Build Docker image
          command: docker build -t asia.gcr.io/${GOOGLE_PROJECT_ID}/my-first-container:${CIRCLE_SHA1} .
      - run:
          name: Push docker image to GCR
          command: docker build -t asia.gcr.io/${GOOGLE_PROJECT_ID}/my-first-container:${CIRCLE_SHA1} .
      - run:
          name: Deploy docker image to app engine
          command: |
            gcloud app deploy app.yaml --image-url=asia.gcr.io/${GOOGLE_PROJECT_ID}/my-first-container:${CIRCLE_SHA1} --quiet --version=${CIRCLE_SHA1}
workflows:
  build-and-deploy:
    jobs:
      - build-push-and-deploy